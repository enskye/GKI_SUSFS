name: Build GKI Kernel with KernelSU + SUSFS4KSU

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      KERNEL_ROOT: ${{ github.workspace }}/kernel_src
      DIST_DIR: ${{ github.workspace }}/out

    steps:
    - name: Checkout workflow repo
      uses: actions/checkout@v3

    - name: Install dependencies
      run: |
        sudo apt update
        sudo apt install -y bc bison build-essential flex patch zip curl libssl-dev \
                            python3 rsync unzip wget git ccache libncurses5-dev

    - name: Install repo tool
      run: |
        mkdir -p ~/.bin
        curl https://storage.googleapis.com/git-repo-downloads/repo > ~/.bin/repo
        chmod a+x ~/.bin/repo
        echo "$HOME/.bin" >> $GITHUB_PATH

    - name: Sync kernel source
      run: |
        mkdir -p kernel_src
        cd kernel_src
        repo init -u https://android.googlesource.com/kernel/common -b android14-6.1-lts
        repo sync -j$(nproc)

    - name: Setup KernelSU
      run: |
        cd $KERNEL_ROOT
        curl -LSs "https://raw.githubusercontent.com/tiann/KernelSU/main/kernel/setup.sh" | bash -s main

    - name: Apply SUSFS4KSU patches
      run: |
        cp ./susfs4ksu/kernel_patches/KernelSU/10_enable_susfs_for_ksu.patch $KERNEL_ROOT/KernelSU/
        cp ./susfs4ksu/kernel_patches/50_add_susfs_in_kernel-android14-6.1.patch $KERNEL_ROOT/
        cp ./susfs4ksu/kernel_patches/fs/susfs.c $KERNEL_ROOT/fs/
        cp ./susfs4ksu/kernel_patches/include/linux/susfs.h $KERNEL_ROOT/include/linux/
        cd $KERNEL_ROOT/KernelSU && patch -p1 < 10_enable_susfs_for_ksu.patch
        cd $KERNEL_ROOT && patch -p1 < 50_add_susfs_in_kernel-android14-6.1.patch || echo "Check failed patches manually"

    - name: Enable KernelSU and SUSFS in config
      run: |
        cd $KERNEL_ROOT
        sed -i 's/# CONFIG_KSU is not set/CONFIG_KSU=y/' common/arch/arm64/configs/gki_defconfig
        sed -i 's/# CONFIG_KSU_SUSFS is not set/CONFIG_KSU_SUSFS=y/' common/arch/arm64/configs/gki_defconfig

    - name: Remove recommended symbols (GKI2)
      run: |
        cd $KERNEL_ROOT
        rm common/android/abi_gki_protected_exports_*

    - name: Build kernel with Bazel
      run: |
        cd $KERNEL_ROOT
        tools/bazel run //common:kernel_aarch64_dist -- --destdir=$DIST_DIR

    - name: Upload all build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: gki-kernel-artifacts
        path: ${{ env.DIST_DIR }}/*
